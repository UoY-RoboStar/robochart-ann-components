include "core_defs.csp"
include "file_Segway_P_defs.csp"
include "Segway.csp"
include "robochart_defs.csp"
include "../instantiations.csp"
include "../../segway parallel ann/defs/file_simplified_segwaycontroller.csp"

channel r__
-- generate Segway
P_Segway = let
	id__ = 0
	
	
	
	const_Segway_SegwayController_stm_ref0_maxAngle = const_BalanceSTM_maxAngle
	const_Segway_SegwayController_stm_ref0_loopTime = const_BalanceSTM_loopTime
	const_Segway_SegwayController_stm_ref0_startupDelay = const_BalanceSTM_startupDelay
	const_Segway_SegwayController_stm_ref0_speedUpdate = const_BalanceSTM_speedUpdate
	const_Segway_SegwayController_stm_ref0_rotationUpdate = const_BalanceSTM_rotationUpdate
	const_Segway_SegwayController_stm_ref0_motorBudget = const_BalanceSTM_motorBudget
	const_Segway_SegwayController_stm_ref0_angleBudget = const_BalanceSTM_angleBudget
	const_Segway_SegwayController_stm_ref0_speedBudget = const_BalanceSTM_speedBudget
	const_Segway_SegwayController_stm_ref0_rotationBudget = const_BalanceSTM_rotationBudget
	const_Segway_SegwayController_stm_ref1_P = const_AnglePID_P
	const_Segway_SegwayController_stm_ref1_D = const_AnglePID_D
	const_Segway_SegwayController_stm_ref2_P = const_SpeedPID_P
	const_Segway_SegwayController_stm_ref2_I = const_SpeedPID_I
	const_Segway_SegwayController_stm_ref2_maxIntegral = const_SpeedPID_maxIntegral
	const_Segway_SegwayController_stm_ref3_D = const_RotationPID_D
		
	
within
	Segway::O__(id__,
			    const_Segway_SegwayController_stm_ref0_maxAngle,
			    const_Segway_SegwayController_stm_ref0_loopTime,
			    const_Segway_SegwayController_stm_ref0_startupDelay,
			    const_Segway_SegwayController_stm_ref0_speedUpdate,
			    const_Segway_SegwayController_stm_ref0_rotationUpdate,
			    const_Segway_SegwayController_stm_ref0_motorBudget,
			    const_Segway_SegwayController_stm_ref0_angleBudget,
			    const_Segway_SegwayController_stm_ref0_speedBudget,
			    const_Segway_SegwayController_stm_ref0_rotationBudget,
			    const_Segway_SegwayController_stm_ref1_P,
			    const_Segway_SegwayController_stm_ref1_D,
			    const_Segway_SegwayController_stm_ref2_P,
			    const_Segway_SegwayController_stm_ref2_I,
			    const_Segway_SegwayController_stm_ref2_maxIntegral,
			    const_Segway_SegwayController_stm_ref3_D)
assert P_Segway :[deadlock-free]	
assert P_Segway;RUN({r__}) :[deadlock-free]
assert P_Segway :[deterministic]
assert P_Segway :[divergence-free]


--THIS IS THE CORRECT VERSION, IT WORKS AT = 0 AND AT = 1.
Simple_Segway_P = SimplifiedSegwayController::H_P[[
SimplifiedSegwayController::leftMotorVelocity <- Segway::leftMotorVelocity,
SimplifiedSegwayController::rightMotorVelocity <- Segway::rightMotorVelocity,
SimplifiedSegwayController::angle <- Segway::angle,
SimplifiedSegwayController::gyroX <- Segway::gyroX,
SimplifiedSegwayController::gyroY <- Segway::gyroY,
SimplifiedSegwayController::gyroZ <- Segway::gyroZ,
SimplifiedSegwayController::setLeftMotorSpeedCall <- Segway::setLeftMotorSpeedCall,
SimplifiedSegwayController::setRightMotorSpeedCall <- Segway::setRightMotorSpeedCall,
SimplifiedSegwayController::enableInterruptsCall <- Segway::enableInterruptsCall,
SimplifiedSegwayController::disableInterruptsCall <- Segway::disableInterruptsCall]]

assert Simple_Segway_P [T= P_Segway
assert P_Segway [T= Simple_Segway_P